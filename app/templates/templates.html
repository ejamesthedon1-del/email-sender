{% extends "base.html" %}

{% block title %}Templates - Email Outreach Platform{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Email Templates</h2>
        <button class="btn btn-primary" onclick="showCreateTemplateModal()">+ Create Template</button>
    </div>
    
    <div class="templates-grid" id="templatesGrid">
        <div class="loading">Loading templates...</div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div id="templateModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modalTitle">Create Template</h3>
            <span class="close" onclick="closeModal('templateModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="templateForm" novalidate>
                <input type="hidden" id="templateId" name="id">
                <div class="form-group">
                    <label>Template Name</label>
                    <input type="text" id="templateName" name="name" required>
                </div>
                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" id="templateSubject" name="subject" required placeholder="e.g., Quick question about {Brokerage}">
                    <small>Use variables like {FirstName}, {Brokerage}, {City}, etc.</small>
                </div>
                <div class="form-group">
                    <label>Body (Plain Text) <span id="bodyRequired" style="color: red; display: inline;">*</span></label>
                    <textarea id="templateBody" name="body" rows="10" placeholder="Hi {FirstName},&#10;&#10;I hope this email finds you well..."></textarea>
                    <small>Required if HTML body is not provided</small>
                </div>
                <div class="form-group">
                    <label>HTML Body (Optional)</label>
                    <textarea id="templateHtml" name="html_body" rows="10" placeholder="<html>...</html>"></textarea>
                    <small>If provided, plain text body becomes optional</small>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="templateDescription" name="description" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="previewTemplate()">Preview</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let editingTemplateId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    
    // Make body optional if HTML exists
    const htmlBodyField = document.getElementById('templateHtml');
    const bodyField = document.getElementById('templateBody');
    const bodyRequired = document.getElementById('bodyRequired');
    
    function updateBodyRequired() {
        const hasHtml = htmlBodyField.value.trim().length > 0;
        if (hasHtml) {
            bodyField.removeAttribute('required');
            bodyRequired.style.display = 'none';
        } else {
            bodyField.setAttribute('required', 'required');
            bodyRequired.style.display = 'inline';
        }
    }
    
    // Update on input for both fields
    htmlBodyField.addEventListener('input', updateBodyRequired);
    htmlBodyField.addEventListener('keyup', updateBodyRequired);
    htmlBodyField.addEventListener('paste', function() {
        setTimeout(updateBodyRequired, 10);
    });
    
    // Also check on page load if editing
    updateBodyRequired();
});

function loadTemplates() {
    fetch('/api/templates')
        .then(res => res.json())
        .then(templates => {
            const grid = document.getElementById('templatesGrid');
            if (templates.length === 0) {
                grid.innerHTML = '<div class="empty-state">No templates yet. Create your first template!</div>';
                return;
            }
            
            grid.innerHTML = templates.map(template => `
                <div class="template-card">
                    <div class="template-header">
                        <h3>${template.name}</h3>
                        <div class="template-actions">
                            <button class="btn btn-sm btn-info" onclick="editTemplate('${template.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="template-body">
                        <div class="template-preview">
                            <strong>Subject:</strong> ${template.subject || '-'}
                        </div>
                        <div class="template-preview">
                            <strong>Body:</strong> ${(template.body || '').substring(0, 100)}${(template.body || '').length > 100 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        });
}

function showCreateTemplateModal() {
    editingTemplateId = null;
    document.getElementById('modalTitle').textContent = 'Create Template';
    document.getElementById('templateForm').reset();
    document.getElementById('templateId').value = '';
    document.getElementById('templateModal').style.display = 'block';
    // Initialize body required state - body is required by default
    const htmlBodyField = document.getElementById('templateHtml');
    const bodyField = document.getElementById('templateBody');
    const bodyRequired = document.getElementById('bodyRequired');
    bodyField.removeAttribute('required'); // Remove initially, will be set by updateBodyRequired
    bodyRequired.style.display = 'inline';
    // Trigger update to set correct state
    setTimeout(() => {
        const hasHtml = htmlBodyField.value.trim().length > 0;
        if (hasHtml) {
            bodyField.removeAttribute('required');
            bodyRequired.style.display = 'none';
        } else {
            bodyField.setAttribute('required', 'required');
            bodyRequired.style.display = 'inline';
        }
    }, 100);
}

function editTemplate(templateId) {
    editingTemplateId = templateId;
    fetch(`/api/templates/${templateId}`)
        .then(res => res.json())
        .then(template => {
            document.getElementById('modalTitle').textContent = 'Edit Template';
            document.getElementById('templateId').value = template.id;
            document.getElementById('templateName').value = template.name || '';
            document.getElementById('templateSubject').value = template.subject || '';
            document.getElementById('templateBody').value = template.body || '';
            document.getElementById('templateHtml').value = template.html_body || '';
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('templateModal').style.display = 'block';
            
            // Update body required state after loading template
            setTimeout(() => {
                const htmlBodyField = document.getElementById('templateHtml');
                const bodyField = document.getElementById('templateBody');
                const bodyRequired = document.getElementById('bodyRequired');
                const hasHtml = htmlBodyField.value.trim().length > 0;
                if (hasHtml) {
                    bodyField.removeAttribute('required');
                    bodyRequired.style.display = 'none';
                } else {
                    bodyField.setAttribute('required', 'required');
                    bodyRequired.style.display = 'inline';
                }
            }, 100);
        });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    editingTemplateId = null;
}

document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields
    const name = document.getElementById('templateName').value.trim();
    const subject = document.getElementById('templateSubject').value.trim();
    const body = document.getElementById('templateBody').value.trim();
    const htmlBody = document.getElementById('templateHtml').value.trim();
    
    if (!name) {
        alert('Please provide a template name.');
        document.getElementById('templateName').focus();
        return;
    }
    
    if (!subject) {
        alert('Please provide a subject.');
        document.getElementById('templateSubject').focus();
        return;
    }
    
    // Validate that at least one body exists
    if (!body && !htmlBody) {
        alert('Please provide either a plain text body or an HTML body (or both).');
        if (!htmlBody) {
            document.getElementById('templateBody').focus();
        } else {
            document.getElementById('templateHtml').focus();
        }
        return;
    }
    
    const data = {
        name: name,
        subject: subject,
        body: body,
        html_body: htmlBody,
        description: document.getElementById('templateDescription').value.trim()
    };
    
    const url = editingTemplateId ? `/api/templates/${editingTemplateId}` : '/api/templates';
    const method = editingTemplateId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(err => { throw new Error(err.error || 'Error saving template'); });
        }
        return res.json();
    })
    .then(template => {
        closeModal('templateModal');
        loadTemplates();
    })
    .catch(err => {
        alert('Error saving template: ' + err.message);
        console.error('Error:', err);
    });
});

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    fetch(`/api/templates/${templateId}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(data => {
            loadTemplates();
        })
        .catch(err => alert('Error deleting template: ' + err.message));
}

function previewTemplate() {
    const subject = document.getElementById('templateSubject').value;
    const body = document.getElementById('templateBody').value;
    const html = document.getElementById('templateHtml').value;
    
    if (!subject && !body) {
        alert('Please enter subject and body to preview');
        return;
    }
    
    const sampleData = {
        FirstName: 'John',
        LastName: 'Doe',
        Brokerage: 'ABC Realty',
        City: 'New York',
        State: 'NY',
        Custom1: 'Commercial',
        Custom2: '5 years'
    };
    
    // Simple preview (replace variables)
    let previewSubject = subject;
    let previewBody = body;
    Object.keys(sampleData).forEach(key => {
        previewSubject = previewSubject.replace(new RegExp(`\\{${key}\\}`, 'g'), sampleData[key]);
        previewBody = previewBody.replace(new RegExp(`\\{${key}\\}`, 'g'), sampleData[key]);
    });
    
    alert(`Subject: ${previewSubject}\n\nBody:\n${previewBody}`);
}
</script>
{% endblock %}

