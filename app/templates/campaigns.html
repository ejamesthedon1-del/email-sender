{% extends "base.html" %}

{% block title %}Campaigns - Email Outreach Platform{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Campaigns</h2>
        <button class="btn btn-primary" onclick="showCreateCampaignModal()">+ Create Campaign</button>
    </div>
    
    <div class="campaigns-list" id="campaignsList">
        <div class="loading">Loading campaigns...</div>
    </div>
</div>

<!-- Create Campaign Modal -->
<div id="createCampaignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Campaign</h3>
            <span class="close" onclick="closeModal('createCampaignModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createCampaignForm">
                <div class="form-group">
                    <label>Campaign Name</label>
                    <input type="text" name="name" required placeholder="My Campaign">
                </div>
                
                <div class="form-group">
                    <label>Template</label>
                    <select name="template_id" id="templateSelect" required>
                        <option value="">Select a template...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>SMTP Accounts</label>
                    <select name="smtp_account_ids" id="smtpAccountSelect" multiple size="4" required>
                        <option value="all">All Active Accounts</option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple. Leave "All Active Accounts" selected to use all, or select specific accounts.</small>
                </div>
                
                <div class="form-group">
                    <label>Contacts</label>
                    <select name="contact_ids" id="contactSelect" multiple size="5">
                        <option value="all">All Pending Contacts</option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple, or leave empty for all pending</small>
                </div>
                
                <div class="form-group">
                    <label>Max Emails (optional)</label>
                    <input type="number" name="max_emails" placeholder="Leave empty for all">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="resend">
                        Allow resending to contacts already sent
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createCampaignModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Campaign</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Functions are defined below, they'll be in global scope
// No need to assign to window since they're defined at script level

document.addEventListener('DOMContentLoaded', function() {
    loadCampaigns();
    loadTemplates();
    loadSmtpAccounts();
    loadContacts();
    setInterval(loadCampaigns, 5000); // Refresh every 5 seconds
    
    // Use event delegation for campaign buttons (works with dynamically loaded content)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('start-campaign-btn')) {
            e.preventDefault();
            const campaignId = e.target.getAttribute('data-campaign-id');
            console.log('Start button clicked for campaign:', campaignId);
            startCampaign(campaignId);
        } else if (e.target.classList.contains('delete-campaign-btn')) {
            e.preventDefault();
            const campaignId = e.target.getAttribute('data-campaign-id');
            console.log('Delete button clicked for campaign:', campaignId);
            deleteCampaign(campaignId);
        } else if (e.target.classList.contains('view-campaign-btn')) {
            e.preventDefault();
            const campaignId = e.target.getAttribute('data-campaign-id');
            console.log('View button clicked for campaign:', campaignId);
            viewCampaign(campaignId);
        }
    });
});

function loadCampaigns() {
    fetch('/api/campaigns')
        .then(res => res.json())
        .then(campaigns => {
            const listDiv = document.getElementById('campaignsList');
            if (campaigns.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No campaigns yet. Create your first campaign!</div>';
                return;
            }
            
            listDiv.innerHTML = campaigns.map(campaign => {
                // Get SMTP account info for display
                let smtpInfo = '';
                if (campaign.smtp_account_ids && campaign.smtp_account_ids.length > 0) {
                    if (campaign.smtp_account_ids.includes('all')) {
                        smtpInfo = '<div class="smtp-info"><small>ðŸ“§ SMTP: All Active Accounts</small></div>';
                    } else {
                        smtpInfo = `<div class="smtp-info"><small>ðŸ“§ SMTP: ${campaign.smtp_account_ids.length} account(s) selected</small></div>`;
                    }
                }
                
                return `
                <div class="campaign-card">
                    <div class="campaign-header">
                        <h3>${campaign.name}</h3>
                        <span class="badge badge-${campaign.status}">${campaign.status}</span>
                    </div>
                    <div class="campaign-body">
                        ${smtpInfo}
                        <div class="campaign-stats">
                            <div class="stat">
                                <span class="stat-label">Sent:</span>
                                <span class="stat-value">${campaign.emails_sent || 0}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Failed:</span>
                                <span class="stat-value">${campaign.emails_failed || 0}</span>
                            </div>
                            ${campaign.status === 'running' ? `
                            <div class="stat">
                                <span class="stat-label">Progress:</span>
                                <span class="stat-value">${campaign.progress?.percentage?.toFixed(1) || 0}%</span>
                            </div>
                            ` : ''}
                        </div>
                        ${campaign.status === 'running' && campaign.progress ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${campaign.progress.percentage || 0}%"></div>
                        </div>
                        ` : ''}
                        <div class="campaign-actions">
                            ${campaign.status === 'pending' ? `
                            <button class="btn btn-sm btn-success start-campaign-btn" data-campaign-id="${campaign.id}" id="start-btn-${campaign.id}">Start</button>
                            ` : ''}
                            ${campaign.status === 'running' ? `
                            <button class="btn btn-sm btn-info view-campaign-btn" data-campaign-id="${campaign.id}">View Progress</button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger delete-campaign-btn" data-campaign-id="${campaign.id}">Delete</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        })
        .catch(err => console.error('Error loading campaigns:', err));
}

function loadTemplates() {
    fetch('/api/templates')
        .then(res => res.json())
        .then(templates => {
            const select = document.getElementById('templateSelect');
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                select.appendChild(option);
            });
        });
}

function loadSmtpAccounts() {
    const select = document.getElementById('smtpAccountSelect');
    if (!select) {
        console.error('SMTP account select element not found');
        return;
    }
    
    fetch('/api/smtp-accounts')
        .then(res => res.json())
        .then(accounts => {
            // Clear existing options except "All Active Accounts"
            select.innerHTML = '<option value="all" selected>All Active Accounts</option>';
            const activeAccounts = accounts.filter(a => a.is_active);
            if (activeAccounts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No active SMTP accounts - Add accounts first';
                option.disabled = true;
                select.appendChild(option);
            } else {
                activeAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${account.from_email})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(err => {
            console.error('Error loading SMTP accounts:', err);
        });
}

function loadContacts() {
    fetch('/api/contacts')
        .then(res => res.json())
        .then(contacts => {
            const select = document.getElementById('contactSelect');
            contacts.filter(c => c.status === 'pending').forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.id;
                option.textContent = `${contact.email} - ${contact.first_name} ${contact.last_name}`.trim();
                select.appendChild(option);
            });
        });
}

function showCreateCampaignModal() {
    const modal = document.getElementById('createCampaignModal');
    if (!modal) {
        console.error('Create campaign modal not found');
        return;
    }
    modal.style.display = 'block';
    // Reload SMTP accounts when modal opens
    loadSmtpAccounts();
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal not found:', modalId);
        return;
    }
    modal.style.display = 'none';
}

document.getElementById('createCampaignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    // Get selected SMTP account IDs
    const smtpAccountSelect = document.getElementById('smtpAccountSelect');
    const allSelectedOptions = Array.from(smtpAccountSelect.selectedOptions).map(opt => opt.value);
    
    // If "all" is selected OR no specific accounts are selected, use 'all'
    // Otherwise, use only the specific account IDs (excluding 'all')
    let smtpAccountIds;
    if (allSelectedOptions.includes('all') || allSelectedOptions.length === 0) {
        smtpAccountIds = ['all'];
    } else {
        // Filter out 'all' if specific accounts are selected
        smtpAccountIds = allSelectedOptions.filter(v => v !== 'all');
    }
    
    console.log('Selected SMTP account IDs:', smtpAccountIds);
    
    const data = {
        name: formData.get('name'),
        template_id: formData.get('template_id'),
        smtp_account_ids: smtpAccountIds,
        max_emails: formData.get('max_emails') ? parseInt(formData.get('max_emails')) : null,
        resend: formData.has('resend'),
        contact_ids: Array.from(document.getElementById('contactSelect').selectedOptions)
            .map(opt => opt.value)
            .filter(v => v !== 'all')
    };
    
    fetch('/api/campaigns', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(campaign => {
        closeModal('createCampaignModal');
        loadCampaigns();
        e.target.reset();
        // Reset SMTP account select to "All Active Accounts"
        smtpAccountSelect.value = 'all';
    })
    .catch(err => alert('Error creating campaign: ' + err.message));
});

function startCampaign(campaignId) {
    console.log('Starting campaign:', campaignId);
    
    // Get the button element
    const button = document.getElementById(`start-btn-${campaignId}`);
    
    if (!button) {
        console.error('Start button not found for campaign:', campaignId);
        alert('Error: Could not find start button. Please refresh the page.');
        return;
    }
    
    // Show loading state
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = 'Starting...';
    
    fetch(`/api/campaigns/${campaignId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(res => {
        console.log('Response status:', res.status);
        if (!res.ok) {
            return res.json().then(err => {
                throw new Error(err.error || `HTTP ${res.status}: ${res.statusText}`);
            });
        }
        return res.json();
    })
    .then(data => {
        console.log('Campaign started successfully:', data);
        // Refresh campaigns list to show updated status
        loadCampaigns();
    })
    .catch(err => {
        console.error('Error starting campaign:', err);
        alert('Error starting campaign: ' + err.message);
        // Re-enable button on error
        button.disabled = false;
        button.textContent = originalText;
        // Refresh to show current status
        loadCampaigns();
    });
}

function deleteCampaign(campaignId) {
    if (!confirm('Are you sure you want to delete this campaign?')) return;
    
    console.log('Deleting campaign:', campaignId);
    fetch(`/api/campaigns/${campaignId}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(data => {
            console.log('Campaign deleted:', data);
            loadCampaigns();
        })
        .catch(err => {
            console.error('Error deleting campaign:', err);
            alert('Error deleting campaign: ' + err.message);
        });
}

function viewCampaign(campaignId) {
    console.log('Viewing campaign:', campaignId);
    fetch(`/api/campaigns/${campaignId}`)
        .then(res => res.json())
        .then(campaign => {
            const info = `Campaign: ${campaign.name}\nStatus: ${campaign.status}\nProgress: ${campaign.progress?.current || 0}/${campaign.progress?.total || 0} (${campaign.progress?.percentage?.toFixed(1) || 0}%)\nSent: ${campaign.emails_sent || 0}\nFailed: ${campaign.emails_failed || 0}\nSMTP Accounts: ${campaign.smtp_account_ids ? campaign.smtp_account_ids.join(', ') : 'All'}`;
            alert(info);
        })
        .catch(err => {
            console.error('Error viewing campaign:', err);
            alert('Error loading campaign details: ' + err.message);
        });
}

// Ensure functions are accessible globally (for onclick handlers)
window.startCampaign = startCampaign;
window.deleteCampaign = deleteCampaign;
window.viewCampaign = viewCampaign;
window.showCreateCampaignModal = showCreateCampaignModal;
window.closeModal = closeModal;
</script>
{% endblock %}

