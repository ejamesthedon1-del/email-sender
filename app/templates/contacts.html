{% extends "base.html" %}

{% block title %}Contacts - Email Outreach Platform{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Contacts</h2>
        <div>
            <button class="btn btn-info" onclick="document.getElementById('validateFile').click()">Validate CSV</button>
            <input type="file" id="validateFile" accept=".csv" style="display:none" onchange="validateCsvEmails(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('uploadFile').click()">Upload CSV</button>
            <button class="btn btn-secondary" onclick="showCleanUploadModal()">Clean & Upload CSV</button>
            <input type="file" id="uploadFile" accept=".csv" style="display:none" onchange="uploadContacts(event)">
            <button class="btn btn-primary" onclick="showAddContactModal()">+ Add Contact</button>
        </div>
    </div>
    
    <div class="contacts-table-container">
        <table class="data-table" id="contactsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Brokerage</th>
                    <th>City</th>
                    <th>Status</th>
                    <th>Sent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <tr><td colspan="8" class="loading">Loading contacts...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="bulk-actions" id="bulkActions" style="display:none">
        <button class="btn btn-danger" onclick="bulkDelete()">Delete Selected</button>
    </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Contact</h3>
            <span class="close" onclick="closeModal('addContactModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addContactForm">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" name="first_name">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" name="last_name">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" name="company">
                </div>
                <div class="form-group">
                    <label>Brokerage</label>
                    <input type="text" name="brokerage">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" name="city">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" name="state">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clean & Upload CSV Modal -->
<div id="cleanUploadModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Clean & Upload CSV</h3>
            <span class="close" onclick="closeModal('cleanUploadModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1rem; color: #666;">
                Upload a CSV file to automatically clean email addresses (removes "mailto:" prefixes) before adding contacts.
            </p>
            <div class="form-group">
                <label>Select CSV File</label>
                <input type="file" id="cleanUploadFile" accept=".csv" onchange="previewCleanCSV(event)" style="padding: 0.5rem;">
            </div>
            <div id="cleanPreview" style="display:none; margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem;">Preview (First 5 rows)</h4>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1rem; background: #f9fafb;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead id="cleanPreviewHeader" style="background: #f0f0f0; font-weight: 600;">
                        </thead>
                        <tbody id="cleanPreviewBody">
                        </tbody>
                    </table>
                </div>
                <div id="cleanStats" style="margin-top: 1rem; padding: 0.75rem; background: #e8f4f8; border-radius: 4px; font-size: 0.9rem;">
                </div>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('cleanUploadModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="cleanUploadBtn" onclick="cleanAndUploadCSV()" disabled>Clean & Upload</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedContacts = new Set();

document.addEventListener('DOMContentLoaded', function() {
    loadContacts();
    document.getElementById('selectAll').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('#contactsTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (e.target.checked) {
                selectedContacts.add(cb.value);
            } else {
                selectedContacts.clear();
            }
        });
        updateBulkActions();
    });
});

function loadContacts() {
    fetch('/api/contacts')
        .then(res => res.json())
        .then(contacts => {
            const tbody = document.getElementById('contactsTableBody');
            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No contacts yet. Upload a CSV or add contacts manually.</td></tr>';
                return;
            }
            
            tbody.innerHTML = contacts.map(contact => `
                <tr>
                    <td><input type="checkbox" value="${contact.id}" onchange="toggleContact('${contact.id}', this.checked)"></td>
                    <td>${contact.email}</td>
                    <td>${contact.first_name} ${contact.last_name}</td>
                    <td>${contact.brokerage || '-'}</td>
                    <td>${contact.city || '-'}</td>
                    <td><span class="badge badge-${contact.status}">${contact.status}</span></td>
                    <td>${contact.sent_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteContact('${contact.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        });
}

function toggleContact(id, checked) {
    if (checked) {
        selectedContacts.add(id);
    } else {
        selectedContacts.delete(id);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    if (selectedContacts.size > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

function uploadContacts(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/contacts/upload', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        alert(`Uploaded ${data.contacts_added} contacts. ${data.contacts_skipped} skipped.`);
        loadContacts();
    })
    .catch(err => alert('Error uploading contacts: ' + err.message));
    event.target.value = '';
}

function showAddContactModal() {
    document.getElementById('addContactModal').style.display = 'block';
}

function showCleanUploadModal() {
    document.getElementById('cleanUploadModal').style.display = 'block';
    // Reset form
    document.getElementById('cleanUploadFile').value = '';
    document.getElementById('cleanPreview').style.display = 'none';
    document.getElementById('cleanUploadBtn').disabled = true;
}

let cleanCSVData = null;

function previewCleanCSV(event) {
    const file = event.target.files[0];
    if (!file) {
        document.getElementById('cleanPreview').style.display = 'none';
        document.getElementById('cleanUploadBtn').disabled = true;
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        // Find email column index
        const emailColIndex = headers.findIndex(h => h.toLowerCase().includes('email'));
        
        if (emailColIndex === -1) {
            alert('No email column found in CSV. Please ensure your CSV has an "email" column.');
            event.target.value = '';
            return;
        }
        
        // Process rows and clean emails
        const cleanedRows = [];
        let cleanedCount = 0;
        let totalRows = 0;
        
        for (let i = 1; i < Math.min(lines.length, 6); i++) { // Preview first 5 rows
            const row = lines[i].split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
            if (row.length > emailColIndex) {
                let email = row[emailColIndex];
                const originalEmail = email;
                
                // Remove mailto: prefix
                if (email.toLowerCase().startsWith('mailto:')) {
                    email = email.substring(7);
                    cleanedCount++;
                }
                
                row[emailColIndex] = email;
                cleanedRows.push({original: originalEmail, cleaned: email, row: row});
            }
        }
        
        // Count total cleaned emails in full file
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
            if (row.length > emailColIndex) {
                totalRows++;
                const email = row[emailColIndex];
                if (email.toLowerCase().startsWith('mailto:')) {
                    cleanedCount++;
                }
            }
        }
        
        // Store cleaned CSV data
        cleanCSVData = {
            file: file,
            headers: headers,
            emailColIndex: emailColIndex,
            totalRows: totalRows,
            cleanedCount: cleanedCount
        };
        
        // Display preview
        const previewHeader = document.getElementById('cleanPreviewHeader');
        previewHeader.innerHTML = '<tr>' + headers.map(h => `<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #ddd;">${h}</th>`).join('') + '</tr>';
        
        const previewBody = document.getElementById('cleanPreviewBody');
        previewBody.innerHTML = cleanedRows.map(item => {
            const cells = item.row.map((cell, idx) => {
                if (idx === emailColIndex) {
                    return `<td style="padding: 0.5rem; border-bottom: 1px solid #eee;">
                        <span style="color: #dc2626; text-decoration: line-through; font-size: 0.85em;">${item.original}</span><br>
                        <span style="color: #059669; font-weight: 500;">${item.cleaned}</span>
                    </td>`;
                }
                return `<td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${cell || '-'}</td>`;
            }).join('');
            return '<tr>' + cells + '</tr>';
        }).join('');
        
        // Display stats
        const stats = document.getElementById('cleanStats');
        stats.innerHTML = `
            <strong>Total rows:</strong> ${totalRows}<br>
            <strong>Emails to clean:</strong> ${cleanedCount} (will remove "mailto:" prefix)<br>
            <strong>Already clean:</strong> ${totalRows - cleanedCount}
        `;
        
        document.getElementById('cleanPreview').style.display = 'block';
        document.getElementById('cleanUploadBtn').disabled = false;
    };
    
    reader.readAsText(file);
}

function cleanAndUploadCSV() {
    if (!cleanCSVData) {
        alert('Please select a CSV file first.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', cleanCSVData.file);
    
    document.getElementById('cleanUploadBtn').disabled = true;
    document.getElementById('cleanUploadBtn').textContent = 'Processing...';
    
    fetch('/api/contacts/clean-upload', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`Successfully cleaned and uploaded ${data.contacts_added} contacts.\n${data.contacts_skipped} skipped.\n${data.emails_cleaned} emails had "mailto:" prefix removed.`);
            closeModal('cleanUploadModal');
            loadContacts();
        }
    })
    .catch(err => {
        alert('Error uploading contacts: ' + err.message);
    })
    .finally(() => {
        document.getElementById('cleanUploadBtn').disabled = false;
        document.getElementById('cleanUploadBtn').textContent = 'Clean & Upload';
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

document.getElementById('addContactForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/contacts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(contact => {
        closeModal('addContactModal');
        loadContacts();
        e.target.reset();
    })
    .catch(err => alert('Error adding contact: ' + err.message));
});

function deleteContact(contactId) {
    if (!confirm('Are you sure you want to delete this contact?')) return;
    
    fetch(`/api/contacts/${contactId}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(data => {
            loadContacts();
        })
        .catch(err => alert('Error deleting contact: ' + err.message));
}

function bulkDelete() {
    if (selectedContacts.size === 0) return;
    if (!confirm(`Are you sure you want to delete ${selectedContacts.size} contacts?`)) return;
    
    fetch('/api/contacts/bulk-delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({contact_ids: Array.from(selectedContacts)})
    })
    .then(res => res.json())
    .then(data => {
        selectedContacts.clear();
        updateBulkActions();
        loadContacts();
    })
    .catch(err => alert('Error deleting contacts: ' + err.message));
}

function validateCsvEmails(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show loading message
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'validationLoading';
    loadingMsg.className = 'validation-status';
    loadingMsg.innerHTML = '<div class="validation-loading">Validating emails in CSV file...</div>';
    document.querySelector('.page-header').after(loadingMsg);
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/contacts/validate-csv', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const loadingEl = document.getElementById('validationLoading');
        if (loadingEl) loadingEl.remove();
        
        if (data.error) {
            alert('Error validating CSV: ' + data.error);
            event.target.value = '';
            return;
        }
        
        // Show validation results
        const resultMsg = document.createElement('div');
        resultMsg.id = 'validationResults';
        resultMsg.className = 'validation-status';
        
        const total = data.valid_count + data.invalid_count;
        const validPercent = total > 0 ? ((data.valid_count / total) * 100).toFixed(1) : 0;
        
        resultMsg.innerHTML = `
            <div class="validation-results">
                <h4>ðŸ“§ Email Validation Results</h4>
                <div class="validation-stats">
                    <div class="stat-item valid">
                        <span class="stat-label">Valid:</span>
                        <span class="stat-value">${data.valid_count}</span>
                    </div>
                    <div class="stat-item invalid">
                        <span class="stat-label">Invalid:</span>
                        <span class="stat-value">${data.invalid_count}</span>
                    </div>
                    <div class="stat-item total">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">${total}</span>
                    </div>
                    <div class="stat-item percent">
                        <span class="stat-label">Valid %:</span>
                        <span class="stat-value">${validPercent}%</span>
                    </div>
                </div>
                ${data.email_column_used ? `
                <div class="validation-info">
                    <small><strong>Email Column Used:</strong> <code>${data.email_column_used}</code></small>
                </div>
                ` : ''}
                ${data.sample_valid_emails && data.sample_valid_emails.length > 0 ? `
                <div class="sample-valid-emails">
                    <strong>Sample validated emails (first 5):</strong>
                    <ul>
                        ${data.sample_valid_emails.map(email => `<li><code>${email}</code></li>`).join('')}
                        ${data.valid_count > 5 ? `<li><em>... and ${data.valid_count - 5} more valid emails</em></li>` : ''}
                    </ul>
                </div>
                ` : ''}
                ${data.invalid_emails && data.invalid_emails.length > 0 ? `
                <div class="invalid-emails-list">
                    <strong>Invalid emails found (showing first 10):</strong>
                    <ul>
                        ${data.invalid_emails.slice(0, 10).map(email => `<li><code>${email}</code></li>`).join('')}
                        ${data.invalid_emails.length > 10 ? `<li><em>... and ${data.invalid_emails.length - 10} more</em></li>` : ''}
                    </ul>
                </div>
                ` : (data.invalid_count > 0 ? `
                <div class="validation-note">
                    <p><em>${data.invalid_count} invalid email(s) were removed, but details are not shown here.</em></p>
                </div>
                ` : (data.invalid_count === 0 && data.valid_count > 0 ? `
                <div class="validation-success">
                    <p>âœ“ <strong>All ${data.valid_count} email(s) in the CSV are valid!</strong></p>
                    ${data.sample_valid_emails && data.sample_valid_emails.length > 0 ? `
                    <p><small>Sample emails validated: ${data.sample_valid_emails.slice(0, 3).join(', ')}${data.valid_count > 3 ? '...' : ''}</small></p>
                    ` : ''}
                </div>
                ` : ''))}
                ${data.download_url ? `
                <div class="validation-actions">
                    <a href="${data.download_url}" download class="btn btn-success">Download Cleaned CSV</a>
                    <button class="btn btn-secondary" onclick="document.getElementById('validationResults').remove()">Close</button>
                </div>
                ` : ''}
            </div>
        `;
        
        document.querySelector('.page-header').after(resultMsg);
        
        // Scroll to results
        resultMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        event.target.value = '';
    })
    .catch(err => {
        const loadingEl = document.getElementById('validationLoading');
        if (loadingEl) loadingEl.remove();
        alert('Error validating CSV: ' + err.message);
        event.target.value = '';
    });
}
</script>
{% endblock %}

