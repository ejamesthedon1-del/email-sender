{% extends "base.html" %}

{% block title %}Contacts - Email Outreach Platform{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Contacts</h2>
        <div>
            <button class="btn btn-secondary" onclick="document.getElementById('uploadFile').click()">Upload CSV</button>
            <input type="file" id="uploadFile" accept=".csv" style="display:none" onchange="uploadContacts(event)">
            <button class="btn btn-primary" onclick="showAddContactModal()">+ Add Contact</button>
        </div>
    </div>
    
    <div class="contacts-table-container">
        <table class="data-table" id="contactsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Brokerage</th>
                    <th>City</th>
                    <th>Status</th>
                    <th>Sent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <tr><td colspan="8" class="loading">Loading contacts...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="bulk-actions" id="bulkActions" style="display:none">
        <button class="btn btn-danger" onclick="bulkDelete()">Delete Selected</button>
    </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Contact</h3>
            <span class="close" onclick="closeModal('addContactModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addContactForm">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" name="first_name">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" name="last_name">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" name="company">
                </div>
                <div class="form-group">
                    <label>Brokerage</label>
                    <input type="text" name="brokerage">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" name="city">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" name="state">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectedContacts = new Set();

document.addEventListener('DOMContentLoaded', function() {
    loadContacts();
    document.getElementById('selectAll').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('#contactsTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (e.target.checked) {
                selectedContacts.add(cb.value);
            } else {
                selectedContacts.clear();
            }
        });
        updateBulkActions();
    });
});

function loadContacts() {
    fetch('/api/contacts')
        .then(res => res.json())
        .then(contacts => {
            const tbody = document.getElementById('contactsTableBody');
            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No contacts yet. Upload a CSV or add contacts manually.</td></tr>';
                return;
            }
            
            tbody.innerHTML = contacts.map(contact => `
                <tr>
                    <td><input type="checkbox" value="${contact.id}" onchange="toggleContact('${contact.id}', this.checked)"></td>
                    <td>${contact.email}</td>
                    <td>${contact.first_name} ${contact.last_name}</td>
                    <td>${contact.brokerage || '-'}</td>
                    <td>${contact.city || '-'}</td>
                    <td><span class="badge badge-${contact.status}">${contact.status}</span></td>
                    <td>${contact.sent_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteContact('${contact.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        });
}

function toggleContact(id, checked) {
    if (checked) {
        selectedContacts.add(id);
    } else {
        selectedContacts.delete(id);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    if (selectedContacts.size > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

function uploadContacts(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/contacts/upload', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        alert(`Uploaded ${data.contacts_added} contacts. ${data.contacts_skipped} skipped.`);
        loadContacts();
    })
    .catch(err => alert('Error uploading contacts: ' + err.message));
    event.target.value = '';
}

function showAddContactModal() {
    document.getElementById('addContactModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

document.getElementById('addContactForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/contacts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(contact => {
        closeModal('addContactModal');
        loadContacts();
        e.target.reset();
    })
    .catch(err => alert('Error adding contact: ' + err.message));
});

function deleteContact(contactId) {
    if (!confirm('Are you sure you want to delete this contact?')) return;
    
    fetch(`/api/contacts/${contactId}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(data => {
            loadContacts();
        })
        .catch(err => alert('Error deleting contact: ' + err.message));
}

function bulkDelete() {
    if (selectedContacts.size === 0) return;
    if (!confirm(`Are you sure you want to delete ${selectedContacts.size} contacts?`)) return;
    
    fetch('/api/contacts/bulk-delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({contact_ids: Array.from(selectedContacts)})
    })
    .then(res => res.json())
    .then(data => {
        selectedContacts.clear();
        updateBulkActions();
        loadContacts();
    })
    .catch(err => alert('Error deleting contacts: ' + err.message));
}
</script>
{% endblock %}

