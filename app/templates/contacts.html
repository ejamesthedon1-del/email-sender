{% extends "base.html" %}

{% block title %}Contacts - Email Outreach Platform{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Contacts</h2>
        <div>
            <button class="btn btn-info" onclick="document.getElementById('validateFile').click()">Validate CSV</button>
            <input type="file" id="validateFile" accept=".csv" style="display:none" onchange="validateCsvEmails(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('uploadFile').click()">Upload CSV</button>
            <input type="file" id="uploadFile" accept=".csv" style="display:none" onchange="uploadContacts(event)">
            <button class="btn btn-primary" onclick="showAddContactModal()">+ Add Contact</button>
        </div>
    </div>
    
    <div class="contacts-table-container">
        <table class="data-table" id="contactsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Brokerage</th>
                    <th>City</th>
                    <th>Status</th>
                    <th>Sent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <tr><td colspan="8" class="loading">Loading contacts...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="bulk-actions" id="bulkActions" style="display:none">
        <button class="btn btn-danger" onclick="bulkDelete()">Delete Selected</button>
    </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Contact</h3>
            <span class="close" onclick="closeModal('addContactModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addContactForm">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" name="first_name">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" name="last_name">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" name="company">
                </div>
                <div class="form-group">
                    <label>Brokerage</label>
                    <input type="text" name="brokerage">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" name="city">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" name="state">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectedContacts = new Set();

document.addEventListener('DOMContentLoaded', function() {
    loadContacts();
    document.getElementById('selectAll').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('#contactsTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (e.target.checked) {
                selectedContacts.add(cb.value);
            } else {
                selectedContacts.clear();
            }
        });
        updateBulkActions();
    });
});

function loadContacts() {
    fetch('/api/contacts')
        .then(res => res.json())
        .then(contacts => {
            const tbody = document.getElementById('contactsTableBody');
            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No contacts yet. Upload a CSV or add contacts manually.</td></tr>';
                return;
            }
            
            tbody.innerHTML = contacts.map(contact => `
                <tr>
                    <td><input type="checkbox" value="${contact.id}" onchange="toggleContact('${contact.id}', this.checked)"></td>
                    <td>${contact.email}</td>
                    <td>${contact.first_name} ${contact.last_name}</td>
                    <td>${contact.brokerage || '-'}</td>
                    <td>${contact.city || '-'}</td>
                    <td><span class="badge badge-${contact.status}">${contact.status}</span></td>
                    <td>${contact.sent_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteContact('${contact.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        });
}

function toggleContact(id, checked) {
    if (checked) {
        selectedContacts.add(id);
    } else {
        selectedContacts.delete(id);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    if (selectedContacts.size > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

function uploadContacts(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/contacts/upload', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        alert(`Uploaded ${data.contacts_added} contacts. ${data.contacts_skipped} skipped.`);
        loadContacts();
    })
    .catch(err => alert('Error uploading contacts: ' + err.message));
    event.target.value = '';
}

function showAddContactModal() {
    document.getElementById('addContactModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

document.getElementById('addContactForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/contacts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(contact => {
        closeModal('addContactModal');
        loadContacts();
        e.target.reset();
    })
    .catch(err => alert('Error adding contact: ' + err.message));
});

function deleteContact(contactId) {
    if (!confirm('Are you sure you want to delete this contact?')) return;
    
    fetch(`/api/contacts/${contactId}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(data => {
            loadContacts();
        })
        .catch(err => alert('Error deleting contact: ' + err.message));
}

function bulkDelete() {
    if (selectedContacts.size === 0) return;
    if (!confirm(`Are you sure you want to delete ${selectedContacts.size} contacts?`)) return;
    
    fetch('/api/contacts/bulk-delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({contact_ids: Array.from(selectedContacts)})
    })
    .then(res => res.json())
    .then(data => {
        selectedContacts.clear();
        updateBulkActions();
        loadContacts();
    })
    .catch(err => alert('Error deleting contacts: ' + err.message));
}

function validateCsvEmails(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show loading message
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'validationLoading';
    loadingMsg.className = 'validation-status';
    loadingMsg.innerHTML = '<div class="validation-loading">Validating emails in CSV file...</div>';
    document.querySelector('.page-header').after(loadingMsg);
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/contacts/validate-csv', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const loadingEl = document.getElementById('validationLoading');
        if (loadingEl) loadingEl.remove();
        
        if (data.error) {
            alert('Error validating CSV: ' + data.error);
            event.target.value = '';
            return;
        }
        
        // Show validation results
        const resultMsg = document.createElement('div');
        resultMsg.id = 'validationResults';
        resultMsg.className = 'validation-status';
        
        const total = data.valid_count + data.invalid_count;
        const validPercent = total > 0 ? ((data.valid_count / total) * 100).toFixed(1) : 0;
        
        resultMsg.innerHTML = `
            <div class="validation-results">
                <h4>ðŸ“§ Email Validation Results</h4>
                <div class="validation-stats">
                    <div class="stat-item valid">
                        <span class="stat-label">Valid:</span>
                        <span class="stat-value">${data.valid_count}</span>
                    </div>
                    <div class="stat-item invalid">
                        <span class="stat-label">Invalid:</span>
                        <span class="stat-value">${data.invalid_count}</span>
                    </div>
                    <div class="stat-item total">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">${total}</span>
                    </div>
                    <div class="stat-item percent">
                        <span class="stat-label">Valid %:</span>
                        <span class="stat-value">${validPercent}%</span>
                    </div>
                </div>
                ${data.email_column_used ? `
                <div class="validation-info">
                    <small><strong>Email Column Used:</strong> <code>${data.email_column_used}</code></small>
                </div>
                ` : ''}
                ${data.sample_valid_emails && data.sample_valid_emails.length > 0 ? `
                <div class="sample-valid-emails">
                    <strong>Sample validated emails (first 5):</strong>
                    <ul>
                        ${data.sample_valid_emails.map(email => `<li><code>${email}</code></li>`).join('')}
                        ${data.valid_count > 5 ? `<li><em>... and ${data.valid_count - 5} more valid emails</em></li>` : ''}
                    </ul>
                </div>
                ` : ''}
                ${data.invalid_emails && data.invalid_emails.length > 0 ? `
                <div class="invalid-emails-list">
                    <strong>Invalid emails found (showing first 10):</strong>
                    <ul>
                        ${data.invalid_emails.slice(0, 10).map(email => `<li><code>${email}</code></li>`).join('')}
                        ${data.invalid_emails.length > 10 ? `<li><em>... and ${data.invalid_emails.length - 10} more</em></li>` : ''}
                    </ul>
                </div>
                ` : (data.invalid_count > 0 ? `
                <div class="validation-note">
                    <p><em>${data.invalid_count} invalid email(s) were removed, but details are not shown here.</em></p>
                </div>
                ` : (data.invalid_count === 0 && data.valid_count > 0 ? `
                <div class="validation-success">
                    <p>âœ“ <strong>All ${data.valid_count} email(s) in the CSV are valid!</strong></p>
                    ${data.sample_valid_emails && data.sample_valid_emails.length > 0 ? `
                    <p><small>Sample emails validated: ${data.sample_valid_emails.slice(0, 3).join(', ')}${data.valid_count > 3 ? '...' : ''}</small></p>
                    ` : ''}
                </div>
                ` : ''))}
                ${data.download_url ? `
                <div class="validation-actions">
                    <a href="${data.download_url}" download class="btn btn-success">Download Cleaned CSV</a>
                    <button class="btn btn-secondary" onclick="document.getElementById('validationResults').remove()">Close</button>
                </div>
                ` : ''}
            </div>
        `;
        
        document.querySelector('.page-header').after(resultMsg);
        
        // Scroll to results
        resultMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        event.target.value = '';
    })
    .catch(err => {
        const loadingEl = document.getElementById('validationLoading');
        if (loadingEl) loadingEl.remove();
        alert('Error validating CSV: ' + err.message);
        event.target.value = '';
    });
}
</script>
{% endblock %}

